<!doctype html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Alle Calls â€“ PrankCall</title>
    <style>
      :root { --bg: #0b0c10; --bg-soft: #0e1016; --card: #121319; --muted: #a3adc2; --text: #eef2f8; --acc: #7c5cff; --border: #23293d; }
      * { box-sizing: border-box; }
      body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: linear-gradient(180deg, var(--bg) 0%, var(--bg-soft) 100%); color: var(--text); line-height: 1.45; }
      header { padding: 14px 16px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 20; background: rgba(11,12,16,0.85); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); }
      h1 { font-size: 18px; margin: 0; }
      .container { max-width: 1000px; margin: 0 auto; padding: 16px; }
      .filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; align-items: center; }
      .filters input, .filters select { background: #0f111a; border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 8px; }
      .calls { display: grid; grid-template-columns: 1fr; gap: 10px; }
      .call { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px; display: grid; grid-template-columns: 2fr 1fr 1fr auto auto; gap: 12px; align-items: center; }
      .call .primary { display: flex; gap: 10px; align-items: center; min-width: 0; }
      .icon { font-size: 22px; }
      .title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .sub { color: var(--muted); font-size: 12px; }
      .status { padding: 4px 8px; border-radius: 999px; font-size: 12px; text-transform: capitalize; display: inline-flex; align-items: center; gap: 6px; border: 1px solid #2a2f45; white-space: nowrap; }
      .status.ended { color: #30d158; border-color: #264a30; background: #122116; }
      .status.failed, .status.cancelled { color: #ff453a; border-color: #4a2626; background: #1f1212; }
      .status.in-progress, .status.ringing, .status.forwarding { color: #ffd60a; border-color: #4a4326; background: #1f1b12; }
      .pill { font-size: 12px; color: var(--muted); min-width: 0; }
      .audio { display: flex; align-items: center; gap: 8px; min-width: 180px; }
      .player { width: 240px; max-width: 100%; height: 32px; }
      .btn { background: #171a26; color: var(--text); border: 1px solid var(--border); padding: 8px 10px; border-radius: 10px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
      .btn:hover { border-color: #3b4160; }
      .btn.play { background: #15162a; border-color: #323462; }
      .empty { border: 1px dashed var(--border); padding: 20px; border-radius: 12px; color: var(--muted); text-align: center; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      @media (max-width: 1100px) { .call { grid-template-columns: 1.8fr 1fr 1fr auto; } .audio { min-width: 140px } }
      @media (max-width: 900px) { .call { grid-template-columns: 1fr; align-items: start; } .row { grid-template-columns: 1fr; } .audio { width: 100% } .player { width: 100% } }
    </style>
  </head>
  <body>
    <header>
      <h1>Alle Calls</h1>
    </header>
    <div class="container">
      <div class="filters">
        <input id="search" placeholder="Zoek op scenario of nummer" />
        <select id="status">
          <option value="">Alle status</option>
          <option value="queued">Queued</option>
          <option value="ringing">Ringing</option>
          <option value="in-progress">In progress</option>
          <option value="forwarding">Forwarding</option>
          <option value="ended">Ended</option>
          <option value="failed">Failed</option>
          <option value="cancelled">Cancelled</option>
          <option value="timeout">Timeout</option>
        </select>
        <select id="limit">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
        <button class="btn" id="reload">Vernieuwen</button>
      </div>
      <div id="calls" class="calls"></div>
      <div id="empty" class="empty" style="display:none;">Nog geen calls gevonden</div>
    </div>

    <script>
      const el = (sel) => document.querySelector(sel)
      const callsEl = el('#calls')
      const emptyEl = el('#empty')

      function token() {
        // Align with app storage key
        return localStorage.getItem('authToken') || ''
      }

      function fmtDate(iso) {
        try { return new Date(iso).toLocaleString('nl-NL') } catch { return '' }
      }
      function fmtDuration(sec) {
        sec = sec || 0
        const m = Math.floor(sec / 60)
        const s = (sec % 60).toString().padStart(2, '0')
        return m + ':' + s
      }

      async function fetchCalls() {
        const limit = el('#limit').value
        const status = el('#status').value
        const params = new URLSearchParams({ limit })
        if (status) params.set('status', status)
        const res = await fetch('/api/calls?' + params.toString(), {
          headers: { 'Authorization': token() ? 'Bearer ' + token() : '' }
        })
        if (!res.ok) {
          const t = await res.text()
          throw new Error('Kon calls niet ophalen: ' + t)
        }
        const data = await res.json()
        return data.calls || []
      }

      function renderCalls(list) {
        callsEl.innerHTML = ''
        const q = (el('#search').value || '').toLowerCase()
        const filtered = list.filter(c => {
          const needle = (c.scenarioName || '') + ' ' + (c.targetPhone || '')
          return needle.toLowerCase().includes(q)
        })
        if (filtered.length === 0) {
          emptyEl.style.display = 'block'
          return
        }
        emptyEl.style.display = 'none'
        for (const c of filtered) {
          const recordingAvailable = Boolean((c.recording && c.recording.isAvailable && c.recording.url) || (c.vapiData && c.vapiData.recordingUrl))
          const row = document.createElement('div')
          row.className = 'call'
          const audioUrl = '/api/calls/' + c._id + '/recording' + (token() ? ('?token=' + encodeURIComponent(token())) : '')
          row.innerHTML = `
            <div class="primary">
              <div class="icon">${c.scenarioIcon || 'ðŸŽ­'}</div>
              <div style="min-width:0;">
                <div class="title">${c.scenarioName || 'Onbekend scenario'}</div>
                <div class="sub">${c.formattedPhone || c.targetPhone || ''}</div>
              </div>
            </div>
            <div class="pill">${fmtDate(c.createdAt)}</div>
            <div class="pill">Duur: ${fmtDuration(c.duration)}</div>
            <div class="pill">
              <span class="status ${c.status}">${c.status}</span>
            </div>
            <div class="audio">
              ${recordingAvailable ? `<audio class="player" preload="none" controls src="${audioUrl}"></audio>` : '<span class="sub">Geen opname</span>'}
            </div>
          `
          callsEl.appendChild(row)
        }
      }

      function wireSearch() {
        el('#search').addEventListener('input', () => renderCalls(lastList))
        el('#status').addEventListener('change', load)
        el('#limit').addEventListener('change', load)
        el('#reload').addEventListener('click', load)
      }

      async function load() {
        try {
          const calls = await fetchCalls()
          lastList = calls
          renderCalls(lastList)
        } catch (e) {
          emptyEl.style.display = 'block'
          emptyEl.textContent = e.message
        }
      }

      wireSearch()
      load()
    </script>
  </body>
  </html>
